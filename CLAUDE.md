# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a T3 Stack take-home challenge implementing a Personal Notes application with role-based access control (RBAC). It uses a Turborepo monorepo structure with Next.js 15, tRPC v11, Drizzle ORM, Better Auth, and Supabase Postgres.

**Stack:** Next.js App Router, React 19, tRPC, Drizzle, Better Auth, Tailwind CSS v4, Zod

## Essential Commands

### Development
```bash
pnpm dev              # Start all apps in watch mode
pnpm dev:next         # Start only Next.js app
```

### Database
```bash
pnpm db:push          # Push Drizzle schema to Supabase
pnpm db:studio        # Open Drizzle Studio
pnpm db:seed          # Seed database with test users and notes
pnpm auth:generate    # Generate Better Auth schema
```

### Code Quality
```bash
pnpm typecheck        # Type-check all packages
pnpm lint             # Lint all packages
pnpm lint:fix         # Auto-fix linting issues
pnpm format           # Check formatting
pnpm format:fix       # Auto-fix formatting
```

### Building
```bash
pnpm build            # Build all packages
pnpm clean            # Clean node_modules
pnpm clean:workspaces # Clean all workspace artifacts
```

### UI Components
```bash
pnpm ui-add           # Add shadcn/ui components interactively
```

## Architecture

### Monorepo Structure

This is a **Turborepo** monorepo with strict workspace boundaries:

**apps/**
- `nextjs/` - Next.js 15 App Router application, the only production app

**packages/**
- `api/` - tRPC v11 router definitions (server-side only, imported by Next.js)
- `auth/` - Better Auth configuration with email/password authentication
- `db/` - Drizzle ORM schemas and client (Supabase Postgres)
- `ui/` - shadcn/ui React components
- `validators/` - Shared Zod schemas for client/server validation

**tooling/**
- Shared configs for ESLint, Prettier, Tailwind, TypeScript

### Key Architectural Patterns

#### tRPC API Layer
- **Context creation**: [packages/api/src/trpc.ts:29-42](packages/api/src/trpc.ts#L29-L42) - Creates context with `db`, `session`, and `authApi`
- **Procedures**:
  - `publicProcedure` - Unauthenticated access (session available if logged in)
  - `protectedProcedure` - Requires authentication, throws `UNAUTHORIZED` if no session
- **Router pattern**: Each router satisfies `TRPCRouterRecord` (see [packages/api/src/router/post.ts](packages/api/src/router/post.ts))
- **Root router**: [packages/api/src/root.ts](packages/api/src/root.ts) - Combines all routers into `appRouter`
- **Middleware**: Includes timing middleware with artificial dev delays (100-500ms)

#### Database & ORM
- **Schema location**: [packages/db/src/schema.ts](packages/db/src/schema.ts)
- **Auth schema**: [packages/db/src/auth-schema.ts](packages/db/src/auth-schema.ts) - Auto-generated by Better Auth CLI
- **Client**: Uses `@vercel/postgres` with Drizzle ORM (pooled connection, port 6543)
- **Config**: [packages/db/drizzle.config.ts](packages/db/drizzle.config.ts) - Converts pooled `:6543` to direct `:5432` for migrations
- **Seed script**: [packages/db/src/seed.ts](packages/db/src/seed.ts) - Uses `pg` client with direct connection (port 5432)
- **Schema pattern**: Use `drizzle-zod` to create insert schemas from tables (e.g., `CreatePostSchema`)

#### Authentication Flow
- **Better Auth init**: [packages/auth/src/index.ts](packages/auth/src/index.ts) - `initAuth()` factory function
- **Server-side**: [apps/nextjs/src/auth/server.ts](apps/nextjs/src/auth/server.ts) - Initializes auth with Next.js cookies plugin
- **Client-side**: [apps/nextjs/src/auth/client.ts](apps/nextjs/src/auth/client.ts) - Client auth hooks
- **CLI schema generation**: `pnpm auth:generate` runs Better Auth CLI using [packages/auth/script/auth-cli.ts](packages/auth/script/auth-cli.ts)
  - ⚠️ **Important**: `auth-cli.ts` is in `script/` directory to prevent accidental imports - it's CLI-only
  - Runtime auth uses [packages/auth/src/index.ts](packages/auth/src/index.ts)

#### Next.js Integration
- **tRPC handler**: [apps/nextjs/src/app/api/trpc/[trpc]/route.ts](apps/nextjs/src/app/api/trpc/%5Btrpc%5D/route.ts) - Connects tRPC router to Next.js API routes
- **Auth handler**: [apps/nextjs/src/app/api/auth/[...all]/route.ts](apps/nextjs/src/app/api/auth/%5B...all%5D/route.ts) - Better Auth catch-all route

### Environment Variables

Required in `.env` (see `.env.example`):
- `POSTGRES_URL` - Supabase Postgres **pooled** connection string (Transaction mode, port 6543)
  - The seed script and drizzle-kit automatically convert this to port 5432 for direct connections
- `AUTH_SECRET` - Better Auth secret (generate with `openssl rand -base64 32`)
- `VERCEL_PROJECT_PRODUCTION_URL` - Production URL for redirects (optional in development)

### Code Sharing Rules

**Critical constraints:**
- `@acme/api` should ONLY be a production dependency in Next.js (server-side only)
- For client/server shared code (e.g., Zod schemas), use `@acme/validators`
- Never import `@acme/api` in client components

### Challenge-Specific Requirements

This codebase is for implementing a **Personal Notes** feature with:
1. **RBAC**: Two roles (`member`, `admin`) with different permissions
2. **Server-side enforcement**: RBAC must be enforced in tRPC context/middleware, not just UI
3. **Database**: Notes table with `title` (required), `content` (optional)
4. **Accessibility**: Focus management, labels, ARIA live regions, keyboard navigation

## Common Patterns

### Adding a New tRPC Router
1. Create router in `packages/api/src/router/your-router.ts`
2. Export router satisfying `TRPCRouterRecord`
3. Add to `appRouter` in [packages/api/src/root.ts](packages/api/src/root.ts)
4. Use `protectedProcedure` for auth-required endpoints
5. Access session via `ctx.session.user` (guaranteed non-null in `protectedProcedure`)

### Adding RBAC Middleware
To enforce roles, create a new middleware in [packages/api/src/trpc.ts](packages/api/src/trpc.ts):
```typescript
const enforceRole = (role: string) =>
  t.middleware(({ ctx, next }) => {
    if (!ctx.session?.user) throw new TRPCError({ code: "UNAUTHORIZED" });
    // Add role check here
    return next({ ctx: { session: ctx.session } });
  });
```

### Adding Database Schema
1. Define table in [packages/db/src/schema.ts](packages/db/src/schema.ts) using `pgTable`
2. Use `createInsertSchema` from `drizzle-zod` for validation
3. Run `pnpm db:push` to sync schema to Supabase
4. For migrations: Use Drizzle's migration tools (not commonly used in this setup)

### Query Patterns
- Use `ctx.db.query.[Table].findMany()` for queries (type-safe relational queries)
- Use `ctx.db.insert/update/delete([Table])` for mutations
- Import helpers from `@acme/db` (e.g., `eq`, `desc`, `and`)

## Important Notes

- **Supabase connection**: Must use free tier, connection string from Supabase dashboard
- **Better Auth CLI**: Always run `pnpm auth:generate` before first `pnpm db:push`
- **Turbo caching**: Uses `.cache/` directory for build artifacts
- **Dev mode timing**: Artificial 100-500ms delays in tRPC for waterfall detection
- **Package naming**: All internal packages use `@acme/*` scope
- **Node version**: ^22.21.0 (check [package.json#engines](package.json#L4))
- **pnpm version**: ^10.19.0

## Testing Approach

### Test Users

The following test users are available in the database:

**Test Credentials (all use password: `Test123.`):**
- **Admin**: `admin@example.com` / `Test123.` (role: `admin`) - Full access to all notes
- **Member 1**: `member1@example.com` / `Test123.` (role: `member`) - Access to own notes only
- **Member 2**: `member2@example.com` / `Test123.` (role: `member`) - Access to own notes only

Each user has 2 pre-created test notes with different statuses (active, draft, archived).

**Creating New Users:**
- Use the signup form on the login page (toggle "Don't have an account? Sign up")
- Better Auth handles email/password authentication with scrypt hashing
- New users default to `member` role (role assignment is server-controlled)
